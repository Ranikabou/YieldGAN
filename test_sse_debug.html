<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .data { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .error { background-color: #f8d7da; color: #721c24; }
        .success { background-color: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <h1>SSE Connection Debug Test</h1>
    
    <div id="training-status" class="status disconnected">Training Channel: Disconnected</div>
    <div id="progress-status" class="status disconnected">Progress Channel: Disconnected</div>
    
    <h2>Training Data Received:</h2>
    <div id="training-data" class="data">No data yet...</div>
    
    <h2>Progress Data Received:</h2>
    <div id="progress-data" class="data">No data yet...</div>
    
    <h2>Console Log:</h2>
    <div id="console-log" class="data" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
    
    <h2>Connection Test:</h2>
    <button onclick="testConnection()">Test Connection</button>
    <button onclick="reconnectChannels()">Reconnect Channels</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <script>
        let trainingEventSource = null;
        let progressEventSource = null;
        let connectionAttempts = 0;
        
        function log(message, type = 'info') {
            const consoleLog = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            consoleLog.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
        }
        
        function testConnection() {
            log('üß™ Testing SSE connection...', 'info');
            
            // Test if we can reach the dashboard
            fetch('/')
                .then(response => {
                    if (response.ok) {
                        log('‚úÖ Dashboard is accessible', 'success');
                    } else {
                        log(`‚ùå Dashboard returned status: ${response.status}`, 'error');
                    }
                })
                .catch(error => {
                    log(`‚ùå Cannot reach dashboard: ${error}`, 'error');
                });
            
            // Test SSE endpoints
            fetch('/events/training')
                .then(response => {
                    if (response.ok) {
                        log('‚úÖ Training SSE endpoint is accessible', 'success');
                    } else {
                        log(`‚ùå Training SSE endpoint returned status: ${response.status}`, 'error');
                    }
                })
                .catch(error => {
                    log(`‚ùå Cannot reach training SSE endpoint: ${error}`, 'error');
                });
        }
        
        function connectTrainingChannel() {
            if (trainingEventSource) {
                trainingEventSource.close();
            }
            
            connectionAttempts++;
            log(`üéØ Attempting to connect to training channel (attempt ${connectionAttempts})...`);
            
            try {
                trainingEventSource = new EventSource('/events/training');
                
                trainingEventSource.onopen = function() {
                    log('üéØ Training channel connected successfully', 'success');
                    document.getElementById('training-status').textContent = 'Training Channel: Connected';
                    document.getElementById('training-status').className = 'status connected';
                };
                
                trainingEventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üéØ Training data received: ${JSON.stringify(data, null, 2)}`, 'success');
                        
                        if (data.type === 'training_update') {
                            document.getElementById('training-data').innerHTML = `
                                <h3>Training Update:</h3>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            `;
                        } else if (data.type === 'connection') {
                            log(`üéØ Training channel info: ${data.message}`, 'info');
                        } else if (data.type === 'heartbeat') {
                            log(`üéØ Training heartbeat received: ${data.timestamp}`, 'info');
                        }
                    } catch (error) {
                        log(`üéØ Error parsing training data: ${error}`, 'error');
                    }
                };
                
                trainingEventSource.onerror = function(error) {
                    log(`üéØ Training channel error: ${error}`, 'error');
                    document.getElementById('training-status').textContent = 'Training Channel: Error';
                    document.getElementById('training-status').className = 'status disconnected';
                    
                    // Try to reconnect after a delay
                    setTimeout(() => {
                        if (connectionAttempts < 5) {
                            log('üîÑ Attempting to reconnect training channel...', 'info');
                            connectTrainingChannel();
                        } else {
                            log('‚ùå Max reconnection attempts reached for training channel', 'error');
                        }
                    }, 2000);
                };
                
            } catch (error) {
                log(`üéØ Error creating training EventSource: ${error}`, 'error');
            }
        }
        
        function connectProgressChannel() {
            if (progressEventSource) {
                progressEventSource.close();
            }
            
            log('üìä Connecting to progress channel...');
            
            try {
                progressEventSource = new EventSource('/events/progress');
                
                progressEventSource.onopen = function() {
                    log('üìä Progress channel connected successfully', 'success');
                    document.getElementById('progress-status').textContent = 'Progress Channel: Connected';
                    document.getElementById('progress-status').className = 'status connected';
                };
                
                progressEventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üìä Progress data received: ${JSON.stringify(data, null, 2)}`, 'success');
                        
                        if (data.type === 'progress') {
                            document.getElementById('progress-data').innerHTML = `
                                <h3>Progress Update:</h3>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            `;
                        } else if (data.type === 'connection') {
                            log(`üìä Progress channel info: ${data.message}`, 'info');
                        } else if (data.type === 'heartbeat') {
                            log(`üìä Progress heartbeat received: ${data.timestamp}`, 'info');
                        }
                    } catch (error) {
                        log(`üìä Error parsing progress data: ${error}`, 'error');
                    }
                };
                
                progressEventSource.onerror = function(error) {
                    log(`üìä Progress channel error: ${error}`, 'error');
                    document.getElementById('progress-status').textContent = 'Progress Channel: Error';
                    document.getElementById('progress-status').className = 'status disconnected';
                };
                
            } catch (error) {
                log(`üìä Error creating progress EventSource: ${error}`, 'error');
            }
        }
        
        function reconnectChannels() {
            log('üîÑ Reconnecting all channels...', 'info');
            connectionAttempts = 0;
            connectTrainingChannel();
            connectProgressChannel();
        }
        
        // Connect on page load
        window.addEventListener('load', function() {
            log('üöÄ Page loaded, connecting to SSE channels...', 'info');
            connectTrainingChannel();
            connectProgressChannel();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            log('üîå Page unloading, closing SSE connections...', 'info');
            if (trainingEventSource) {
                trainingEventSource.close();
            }
            if (progressEventSource) {
                progressEventSource.close();
            }
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                log('üëÅÔ∏è Page hidden', 'info');
            } else {
                log('üëÅÔ∏è Page visible', 'info');
                // Reconnect if connections were lost
                if (trainingEventSource && trainingEventSource.readyState === EventSource.CLOSED) {
                    log('üîÑ Reconnecting training channel after page became visible', 'info');
                    connectTrainingChannel();
                }
                if (progressEventSource && progressEventSource.readyState === EventSource.CLOSED) {
                    log('üîÑ Reconnecting progress channel after page became visible', 'info');
                    connectProgressChannel();
                }
            }
        });
        
        // Log initial status
        log('‚úÖ SSE Debug Test initialized', 'success');
    </script>
</body>
</html> 