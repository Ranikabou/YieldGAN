<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Updates Test - Treasury GAN</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">🧪 Dashboard Updates Test</h1>
        
        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">🎮 Training Controls</h2>
            <div class="flex space-x-4">
                <button id="start-training" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    ▶️ Start Training
                </button>
                <button id="stop-training" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium" disabled>
                    ⏹️ Stop Training
                </button>
                <button id="test-sse" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    🔌 Test SSE Connection
                </button>
            </div>
            <div id="control-status" class="mt-4 text-sm text-gray-600">
                Ready to test training flow
            </div>
        </div>
        
        <!-- Training Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <span class="text-2xl">📊</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-700">Training Status</h3>
                        <p id="status-text" class="text-2xl font-bold text-blue-600">Idle</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <span class="text-2xl">🎯</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-700">Generator Loss</h3>
                        <p id="gen-loss" class="text-2xl font-bold text-green-600">0.0000</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <span class="text-2xl">🛡️</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-700">Discriminator Loss</h3>
                        <p id="disc-loss" class="text-2xl font-bold text-red-600">0.0000</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <span class="text-2xl">🔄</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-700">Epoch</h3>
                        <p id="current-epoch" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">📈 Training Progress</h3>
                <canvas id="trainingChart" width="400" height="300"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">🎯 Real vs Synthetic Scores</h3>
                <canvas id="scoresChart" width="400" height="300"></canvas>
            </div>
        </div>
        
        <!-- SSE Status -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">🔌 SSE Connection Status</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-3 bg-gray-50 rounded border">
                    <div class="font-medium text-gray-700">Training Channel</div>
                    <div id="training-status" class="text-sm text-gray-600">Disconnected</div>
                </div>
                <div class="p-3 bg-gray-50 rounded border">
                    <div class="font-medium text-gray-700">Progress Channel</div>
                    <div id="progress-status" class="text-sm text-gray-600">Disconnected</div>
                </div>
                <div class="p-3 bg-gray-50 rounded border">
                    <div class="font-medium text-gray-700">Log Channel</div>
                    <div id="log-status" class="text-sm text-gray-600">Disconnected</div>
                </div>
            </div>
        </div>
        
        <!-- Event Log -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">📝 Event Log</h3>
            <div id="event-log" class="bg-gray-50 p-4 rounded border max-h-64 overflow-y-auto text-sm">
                <div class="text-gray-500">No events yet...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize charts
        let trainingChart, scoresChart;
        
        function initializeCharts() {
            const trainingCtx = document.getElementById('trainingChart').getContext('2d');
            const scoresCtx = document.getElementById('scoresChart').getContext('2d');
            
            trainingChart = new Chart(trainingCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Generator Loss',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Discriminator Loss',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            scoresChart = new Chart(scoresCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Real Scores',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Fake Scores',
                        data: [],
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }
        
        // SSE Event Sources
        let trainingEventSource, progressEventSource, logEventSource;
        
        function connectTrainingChannel() {
            if (trainingEventSource) {
                trainingEventSource.close();
            }
            
            trainingEventSource = new EventSource('/events/training');
            
            trainingEventSource.onopen = function() {
                console.log('🎯 Connected to Training SSE Channel');
                document.getElementById('training-status').textContent = 'Connected';
                addEventLog('🎯 Training channel connected');
            };
            
            trainingEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('🎯 Training data received:', data);
                
                if (data.type === 'training_update') {
                    updateDashboard(data);
                    addEventLog(`📊 Training Update: Epoch ${data.data.epoch}, Gen: ${data.data.generator_loss.toFixed(4)}, Disc: ${data.data.discriminator_loss.toFixed(4)}`);
                } else if (data.type === 'connection') {
                    addEventLog(`🎯 Training channel: ${data.message}`);
                }
            };
            
            trainingEventSource.onerror = function() {
                console.error('🎯 Training channel connection error');
                document.getElementById('training-status').textContent = 'Disconnected';
                addEventLog('❌ Training channel disconnected');
            };
        }
        
        function connectProgressChannel() {
            if (progressEventSource) {
                progressEventSource.close();
            }
            
            progressEventSource = new EventSource('/events/progress');
            
            progressEventSource.onopen = function() {
                console.log('📊 Connected to Progress SSE Channel');
                document.getElementById('progress-status').textContent = 'Connected';
                addEventLog('📊 Progress channel connected');
            };
            
            progressEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('📊 Progress data received:', data);
                
                if (data.type === 'progress') {
                    addEventLog(`📈 Progress: Epoch ${data.epoch}, ${data.progress_percent}%`);
                } else if (data.type === 'connection') {
                    addEventLog(`📊 Progress channel: ${data.message}`);
                }
            };
            
            progressEventSource.onerror = function() {
                console.error('📊 Progress channel connection error');
                document.getElementById('progress-status').textContent = 'Disconnected';
                addEventLog('❌ Progress channel disconnected');
            };
        }
        
        function connectLogChannel() {
            if (logEventSource) {
                logEventSource.close();
            }
            
            logEventSource = new EventSource('/events/logs');
            
            logEventSource.onopen = function() {
                console.log('📝 Connected to Log SSE Channel');
                document.getElementById('log-status').textContent = 'Connected';
                addEventLog('📝 Log channel connected');
            };
            
            logEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('📝 Log data received:', data);
                
                if (data.type === 'log_entry') {
                    addEventLog(`📝 Log: ${data.message}`);
                } else if (data.type === 'connection') {
                    addEventLog(`📝 Log channel: ${data.message}`);
                }
            };
            
            logEventSource.onerror = function() {
                console.error('📝 Log channel connection error');
                document.getElementById('log-status').textContent = 'Disconnected';
                addEventLog('❌ Log channel disconnected');
            };
        }
        
        function disconnectAllChannels() {
            if (trainingEventSource) {
                trainingEventSource.close();
                trainingEventSource = null;
            }
            if (progressEventSource) {
                progressEventSource.close();
                progressEventSource = null;
            }
            if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
            }
        }
        
        function updateDashboard(data) {
            if (data.type === 'training_update') {
                // Update status elements
                document.getElementById('gen-loss').textContent = data.data.generator_loss.toFixed(4);
                document.getElementById('disc-loss').textContent = data.data.discriminator_loss.toFixed(4);
                document.getElementById('current-epoch').textContent = data.data.epoch;
                
                // Update charts
                trainingChart.data.labels.push(data.data.epoch);
                trainingChart.data.datasets[0].data.push(data.data.generator_loss);
                trainingChart.data.datasets[1].data.push(data.data.discriminator_loss);
                trainingChart.update();
                
                scoresChart.data.labels.push(data.data.epoch);
                scoresChart.data.datasets[0].data.push(data.data.real_scores);
                scoresChart.data.datasets[1].data.push(data.data.fake_scores);
                scoresChart.update();
            }
        }
        
        function addEventLog(message) {
            const logDiv = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-2 p-2 bg-white rounded border-l-4 border-blue-500';
            logEntry.innerHTML = `<span class="text-gray-500 text-xs">${timestamp}</span> ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Keep only last 50 entries
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }
        
        // Button event listeners
        document.getElementById('start-training').addEventListener('click', async () => {
            try {
                addEventLog('🚀 Starting training...');
                document.getElementById('control-status').textContent = 'Starting training...';
                
                const response = await fetch('/api/start_training', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        config: 'config/gan_config.yaml',
                        data_source: 'csv'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    addEventLog('✅ Training started successfully');
                    document.getElementById('status-text').textContent = 'Running';
                    document.getElementById('status-text').className = 'text-2xl font-bold text-green-600';
                    
                    // Update button states
                    document.getElementById('start-training').disabled = true;
                    document.getElementById('start-training').classList.add('opacity-50', 'cursor-not-allowed');
                    document.getElementById('stop-training').disabled = false;
                    document.getElementById('stop-training').classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    document.getElementById('control-status').textContent = 'Training is running';
                } else {
                    addEventLog(`❌ Failed to start training: ${result.error}`);
                    document.getElementById('control-status').textContent = `Error: ${result.error}`;
                }
            } catch (error) {
                addEventLog(`❌ Error starting training: ${error.message}`);
                document.getElementById('control-status').textContent = `Error: ${error.message}`;
            }
        });
        
        document.getElementById('stop-training').addEventListener('click', async () => {
            try {
                addEventLog('⏹️ Stopping training...');
                document.getElementById('control-status').textContent = 'Stopping training...';
                
                const response = await fetch('/api/stop_training', {method: 'POST'});
                const result = await response.json();
                if (result.success) {
                    addEventLog('✅ Training stopped successfully');
                    document.getElementById('status-text').textContent = 'Stopped';
                    document.getElementById('status-text').className = 'text-2xl font-bold text-red-600';
                    
                    // Update button states
                    document.getElementById('start-training').disabled = false;
                    document.getElementById('start-training').classList.remove('opacity-50', 'cursor-not-allowed');
                    document.getElementById('stop-training').disabled = true;
                    document.getElementById('stop-training').classList.add('opacity-50', 'cursor-not-allowed');
                    
                    document.getElementById('control-status').textContent = 'Training stopped';
                } else {
                    addEventLog(`❌ Failed to stop training: ${result.error}`);
                }
            } catch (error) {
                addEventLog(`❌ Error stopping training: ${error.message}`);
            }
        });
        
        document.getElementById('test-sse').addEventListener('click', function() {
            addEventLog('🔌 Testing SSE connections...');
            connectTrainingChannel();
            connectProgressChannel();
            connectLogChannel();
        });
        
        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('🚀 Page loaded, initializing charts and SSE channels');
            initializeCharts();
            addEventLog('🚀 Dashboard loaded and ready');
        });
    </script>
</body>
</html> 